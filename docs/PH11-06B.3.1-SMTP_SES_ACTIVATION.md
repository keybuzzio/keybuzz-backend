# PH11-06B.3.1 - SMTP/SES Activation (Outbound Email)

**Date:** 16 Décembre 2025  
**Statut:** ✅ SMTP Fonctionnel (internal relay), SES en attente credentials AWS  
**Commits:**
- `d1de5f6` - fix(vault): Read SMTP/SES secrets from KV v2 correctly
- `5b4f021` - fix(smtp): Accept self-signed cert + increase timeout
- `c5a098d` - fix(smtp): Use internal relay port 25 without auth

---

## Objectif

Activer l'envoi d'emails outbound via :
1. **SMTP** (primary) - mail-core-01 via relay interne
2. **SES** (fallback) - Amazon SES (en attente credentials)

**Contraintes:**
- Secrets dans Vault (PAS dans .env)
- Port 587 STARTTLS → abandonné (SASL auth bug)
- Port 25 relay interne → **SOLUTION RETENUE**
- Réseau privé uniquement

---

## Architecture

```
Backend-01 (10.0.0.250)
    ↓ SMTP port 25 (no auth, no TLS)
mail-core-01 (10.0.0.160)
    ↓ Postfix relay
Internet (MX keybuzz.io)
```

---

## Vault Secrets

### SMTP
**Path:** `secret/keybuzz/smtp`
```json
{
  "host": "10.0.0.160",
  "port": "25",
  "user": "",
  "password": "",
  "from": "amazon@inbound.keybuzz.io"
}
```

### SES (fallback)
**Path:** `secret/keybuzz/ses`
```json
{
  "access_key": "<AWS_ACCESS_KEY>",
  "secret_key": "<AWS_SECRET_KEY>",
  "region": "eu-west-1"
}
```
⚠️ Credentials AWS non fournis - SES non testé

---

## Backend Code

### 1. Vault Helper
**`src/lib/vault.ts`**
- Ajout fonction `getVaultObject(path)` pour lire secrets KV v2
- Retourne objet complet au lieu de valeur unique

### 2. Outbound Email Service  
**`src/modules/outbound/outboundEmail.service.ts`**
- Utilise `getVaultObject("smtp")` et `getVaultObject("ses")`
- Auth conditionnelle : skip si user/pass vides
- TLS désactivé si port 25 (`ignoreTLS: true`)
- Timeout 10s

---

## Postfix Configuration (mail-core-01)

### mynetworks (STRICT)
```
mynetworks = 127.0.0.0/8 [::1]/128 10.0.0.250/32
smtpd_recipient_restrictions = permit_mynetworks,reject_unauth_destination
smtpd_relay_restrictions = permit_mynetworks,reject_unauth_destination
```

**✅ PAS d'open relay** - Seuls localhost et backend-01 peuvent relay

### Port 25 (SMTP)
- Écoute sur `0.0.0.0:25`
- Relay autorisé depuis `10.0.0.250/32` uniquement
- Pas d'auth requise (réseau privé)
- Pas de TLS (communication interne)

---

## Fixes Appliqués

### 1. DATABASE_URL Fix
**Problème:** HAProxy routait vers replicas read-only
**Solution:** DATABASE_URL pointe directement vers leader PostgreSQL
```
postgresql://kb_backend:<password>@10.0.0.122:5432/keybuzz_backend
```

### 2. DNS Resolution Fix
**Problème:** `mail.keybuzz.io` résolvait vers IP publique (49.13.35.167)
**Solution:** `/etc/hosts` sur backend-01
```
10.0.0.160 mail.keybuzz.io
```

### 3. SASL Auth Bug (NON RÉSOLU)
**Problème:** Port 587 + SASL auth échouait systématiquement (25+ tentatives)
**Décision:** Contourner avec relay interne port 25 (ultra-sécurisé)
**Rollback possible:** SASL reste configuré sur port 587 (non utilisé)

---

## Tests E2E

### Test SMTP Success ✅
```bash
curl -X POST http://127.0.0.1:4000/internal/outbound/email \
  -H "Content-Type: application/json" \
  -H "x-ops-key: 8f4e92a1-d3c7-4b5e-9a8f-1c2d3e4f5a6b" \
  -d '{
    "tenantId": "kbz_test",
    "ticketId": "ticket_smtp_test_001",
    "to": "test@example.com",
    "subject": "Test",
    "body": "Test email"
  }'
```

**Résultat:**
- `OutboundEmail.provider = SMTP`
- `OutboundEmail.status = SENT`
- `OutboundEmail.sentAt = 2025-12-16 13:35:56`
- Postfix logs: `status=bounced (Domain example.com does not accept mail)` ← Normal pour domaine test

### Test SES Fallback ⏸️
En attente credentials AWS (access_key + secret_key)

---

## SSH Fabric Restoration ✅

**Problème:** install-v3 n'avait accès qu'à backend-01  
**Solution:** Config SSH avec clé `id_rsa_keybuzz_v3` par défaut  
**Résultat:** 48/48 serveurs accessibles via `ssh root@IP`

---

## Sécurité

### ✅ Points validés
- Secrets Vault (PAS dans .env)
- mynetworks strict (10.0.0.250/32 uniquement)
- Pas d'open relay (testé)
- Pas de port 25 sortant Internet (firewall Hetzner)
- Réseau privé uniquement

### ⚠️ Points d'attention
- VAULT_TOKEN en clair dans .env.production (à améliorer avec AppRole)
- Port 25 sans TLS (acceptable réseau privé)
- SASL auth non résolu (investigation future si besoin port 587)

---

## Prochaines Étapes

1. **SES Fallback:** Configurer credentials AWS + tester
2. **TicketEvent Fix:** Corriger enum Prisma pour `OUTBOUND_EMAIL_SENT`
3. **SASL Investigation:** Si besoin port 587 authentifié (strace/debug)
4. **Vault AppRole:** Remplacer VAULT_TOKEN statique

---

**Auteur:** Agent CE  
**Validation:** Production backend-01 ✅
