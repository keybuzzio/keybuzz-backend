# PH11-06C.2 - Scheduler Systemd (Jobs périodiques)

**Date:** 16 Décembre 2025  
**Statut:** ✅ Fonctionnel en production  
**Commit:** `0c066fd` (feat(scheduler): PH11-06C.2 - Systemd scheduler for periodic jobs)

---

## Objectif

Mettre en place un mécanisme de scheduling robuste sur `backend-01` pour :
- Polling Amazon périodique (toutes les 5 minutes)
- Jobs périodiques futurs (retries, cleanups, etc.)

**Contrainte:** Utiliser `systemd` timers (PAS cron)

---

## Architecture

```
systemd timer (5 min)
    ↓
keybuzz-jobs-enqueue.service (oneshot)
    ↓
npm run jobs:enqueue
    ↓
enqueueScheduledJobs.ts
    ↓
PostgreSQL Job table (AMAZON_POLL jobs)
    ↓
keybuzz-jobs-worker.service (continuous)
```

---

## Fichiers créés

### 1. Script Enqueuer
**`src/scripts/enqueueScheduledJobs.ts`**
- Charge tous les tenants avec `MarketplaceConnection` status=CONNECTED type=AMAZON
- Enqueue un job `AMAZON_POLL` pour chaque tenant
- Loggé dans journalctl

### 2. Systemd Service
**`/etc/systemd/system/keybuzz-jobs-enqueue.service`**
```ini
[Unit]
Description=KeyBuzz Jobs Enqueuer (scheduled jobs)
After=network.target

[Service]
Type=oneshot
WorkingDirectory=/opt/keybuzz/keybuzz-backend
ExecStart=/usr/bin/npm run jobs:enqueue
EnvironmentFile=/opt/keybuzz/keybuzz-backend/.env.production
User=root
StandardOutput=journal
StandardError=journal
```

### 3. Systemd Timer
**`/etc/systemd/system/keybuzz-jobs-enqueue.timer`**
```ini
[Unit]
Description=Run KeyBuzz Jobs Enqueuer every 5 minutes

[Timer]
OnBootSec=60
OnUnitActiveSec=300
Persistent=true

[Install]
WantedBy=timers.target
```

### 4. npm script
**`package.json`**
```json
"scripts": {
  "jobs:enqueue": "node dist/scripts/enqueueScheduledJobs.js"
}
```

---

## Déploiement

```bash
# Sur backend-01
systemctl daemon-reload
systemctl enable keybuzz-jobs-enqueue.timer
systemctl start keybuzz-jobs-enqueue.timer

# Vérifier
systemctl list-timers | grep keybuzz
systemctl status keybuzz-jobs-enqueue.timer
```

---

## Validation

```bash
# 1. Vérifier que le timer fonctionne
systemctl list-timers | grep keybuzz-jobs-enqueue

# 2. Déclencher manuellement
systemctl start keybuzz-jobs-enqueue.service
journalctl -u keybuzz-jobs-enqueue -n 20

# 3. Vérifier les jobs créés
curl -H "x-ops-key: 8f4e92a1-d3c7-4b5e-9a8f-1c2d3e4f5a6b" \
  http://localhost:4000/internal/ops/jobs/stats

# 4. Vérifier que le worker consomme
journalctl -u keybuzz-jobs-worker -f
```

---

## Résultat

✅ Jobs `AMAZON_POLL` créés toutes les 5 minutes  
✅ Worker consomme et traite les jobs  
✅ Status `DONE` dans les logs  
✅ Timer survit aux redémarrages (Persistent=true)

---

**Auteur:** Agent CE  
**Validation:** Production backend-01
