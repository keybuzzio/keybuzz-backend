# PH11-06B.5A : Inbound Email Validation (Auto-forwarding Addresses)

**Date** : 2025-12-16  
**Statut** : ‚úÖ Impl√©ment√© et test√©  
**Epic** : PH11-06B (Inbound Email Processing)

## üìã Objectif

Impl√©menter un syst√®me de validation automatique des adresses email inbound canoniques par marketplace/country, avec self-test loop (envoi email ‚Üí r√©ception ‚Üí validation).

## üèóÔ∏è Architecture

### Format Adresse Canonique

```
<marketplace>.<tenantId>.<country>.<token>@inbound.keybuzz.io
```

**Exemple** : `amazon.kbz_001.fr.x7p4@inbound.keybuzz.io`

- `marketplace` : `AMAZON` (extensible EBAY, CDISCOUNT, etc.)
- `tenantId` : ID unique tenant
- `country` : Code pays ISO `FR`, `DE`, `UK`, etc.
- `token` : Token alphanum√©rique 4-8 chars pour validation

### Mod√®les Prisma

**InboundConnection** : Connexion marketplace par tenant
- `tenantId`, `marketplace`, `countries[]`, `status`

**InboundAddress** : Adresse inbound par country
- `connectionId`, `tenantId`, `marketplace`, `country`
- `token`, `emailAddress`
- `validationStatus` : `PENDING` | `VALIDATED` | `FAILED`
- `lastInboundAt`, `lastInboundMessageId`, `lastError`

### Tables PostgreSQL

- `inbound_connections` (colonnes camelCase)
- `inbound_addresses` (colonnes camelCase)

Convention : noms de table snake_case, colonnes camelCase (comme `Tenant`).

## üîÑ Flow Validation

### 1. Cr√©ation Connection + Addresses

```typescript
await ensureInboundConnection({
  tenantId: 'kbz_001',
  marketplace: 'AMAZON',
  countries: ['FR', 'DE', 'UK'],
});
```

Cr√©e :
- 1 `InboundConnection`
- 3 `InboundAddress` (1 par country) avec token unique

### 2. Envoi Email Validation

```typescript
await sendValidationEmail(connectionId, 'FR');
```

Enqueue job `OUTBOUND_EMAIL_SEND` :
- `to: amazon.kbz_001.fr.x7p4@inbound.keybuzz.io`
- `subject: "KeyBuzz Validation <connectionId> <country> <token>"`

### 3. R√©ception Email (Webhook Postfix)

```
POST /api/v1/inbound/email
{
  "to": "amazon.kbz_001.fr.x7p4@inbound.keybuzz.io",
  "subject": "KeyBuzz Validation conn_001 FR x7p4",
  ...
}
```

### 4. D√©tection Validation

`inbound.service.ts` :
- Parse address ‚Üí extract `tenantId`, `marketplace`, `country`, `token`
- Parse subject ‚Üí extract validation token
- Si match ‚Üí `processValidationEmail()` :
  - Marque `InboundAddress.validationStatus = VALIDATED`
  - Set `lastInboundAt = now()`, `lastInboundMessageId`
  - Return `{ validation: true, addressId }`
- Sinon ‚Üí flow normal (cr√©ation Ticket)

### 5. R√©g√©n√©ration Token

Si validation √©choue ou expiration :

```typescript
await regenerateToken(addressId);
```

G√©n√®re nouveau token, reset status `PENDING`.

## üõ†Ô∏è Services Impl√©ment√©s

### `inboundEmailAddress.service.ts`
- `buildInboundAddress()` : g√©n√®re adresse canonique
- `generateToken()` : g√©n√®re token alphanum√©rique
- `ensureInboundConnection()` : upsert connection + addresses

### `inboundEmailValidation.service.ts`
- `sendValidationEmail()` : enqueue email validation
- `regenerateToken()` : r√©g√©n√®re token

### `inbound.service.ts`
- `parseInboundAddress()` : parse format canonique/legacy
- `isValidationEmail()` : d√©tecte email validation
- `processValidationEmail()` : traite validation

### `inbound.routes.ts`
- Hook validation **avant** cr√©ation Ticket
- Si validation ‚Üí skip Ticket, return `{ validation: true }`

## üåê API Endpoints (JWT Protected)

### `GET /api/v1/inbound-email/connections`
Liste toutes les connections pour tenant.

### `GET /api/v1/inbound-email/connections/:id`
D√©tail connection avec addresses.

### `POST /api/v1/inbound-email/connections`
Cr√©e/update connection.
```json
{
  "marketplace": "AMAZON",
  "countries": ["FR", "DE"]
}
```

### `POST /api/v1/inbound-email/connections/:id/validate`
Envoie email validation.
```json
{
  "country": "FR"  // Optionnel (tous si absent)
}
```

### `POST /api/v1/inbound-email/addresses/:id/regenerate`
R√©g√©n√®re token pour adresse.

### `GET /api/v1/inbound-email/health`
Health indicators (DKIM, DMARC, MTA-STS, etc.) - mock pour l'instant.

## ‚úÖ Tests E2E

### Test 1 : Email Validation
```bash
curl -X POST http://127.0.0.1:4000/api/v1/inbound/email \
  -d '{
    "to": "amazon.kbz_test.fr.x7p4fr@inbound.keybuzz.io",
    "subject": "KeyBuzz Validation conn_test_001 FR x7p4fr",
    ...
  }'
```

**R√©sultat** : `{ "validation": true, "addressId": "addr_test_fr" }`  
**DB** : `validationStatus = VALIDATED`, `lastInboundAt = now()`

### Test 2 : Email Normal
```bash
curl -X POST http://127.0.0.1:4000/api/v1/inbound/email \
  -d '{
    "to": "amazon.kbz_test.de.k9m2de@inbound.keybuzz.io",
    "subject": "Question commande #12345",
    ...
  }'
```

**R√©sultat** : `{ "ticketId": "..." }`  
**DB** : Ticket cr√©√© normalement

## üöÄ D√©ploiement

### Migration DB
```bash
cd /opt/keybuzz/keybuzz-backend
psql $DATABASE_URL < /tmp/create_inbound_tables.sql
```

### Restart Backend
```bash
systemctl restart keybuzz-backend
systemctl restart keybuzz-jobs-worker
```

### V√©rification
```bash
curl http://127.0.0.1:4000/health
psql $DATABASE_URL -c '\d "inbound_connections"'
psql $DATABASE_URL -c '\d "inbound_addresses"'
```

## üìä Monitoring

### Tables DB
- `SELECT * FROM "inbound_connections" WHERE "tenantId" = ?`
- `SELECT * FROM "inbound_addresses" WHERE "validationStatus" = 'PENDING'`

### Logs Backend
```bash
journalctl -u keybuzz-backend -f | grep -i validation
```

### M√©triques
- `inbound_addresses.validationStatus` : `PENDING` / `VALIDATED` / `FAILED`
- `inbound_addresses.lastInboundAt` : derni√®re r√©ception email

## üîí S√©curit√©

- Token alphanum√©rique 6 chars (suffisant pour √©viter guessing)
- Validation stricte : token subject **doit** matcher token address
- Foreign keys `ON DELETE CASCADE` : cleanup auto si tenant supprim√©
- JWT auth requise pour tous endpoints `/api/v1/inbound-email/*`

## üîÆ Roadmap

### PH11-06B.5B : Auto-Forwarding Activation
- Int√©gration UI Admin (PH11-06B.4 d√©j√† fait)
- Instructions Amazon Seller Central (forwarding setup)
- Monitoring validation status

### PH11-06B.5C : Health Indicators
- DKIM inbound verification
- DMARC policy check
- MTA-STS validation
- Webhook Postfix availability

### PH11-06B.6 : Multi-Marketplace
- Support EBAY, CDISCOUNT, FNAC
- Marketplace-specific token formats

## üìù Changelog

**2025-12-16** : Impl√©mentation compl√®te PH11-06B.5A
- ‚úÖ Prisma models `InboundConnection` + `InboundAddress`
- ‚úÖ Services g√©n√©ration adresse + validation
- ‚úÖ Hook validation dans handler inbound
- ‚úÖ API endpoints JWT-protected
- ‚úÖ Tests E2E validation flow
- ‚úÖ Documentation

## üîó R√©f√©rences

- Epic : PH11-06B (Inbound Email Processing)
- UI : PH11-06B.4 (Admin UI Inbound Email Health)
- Outbound : PH11-06B.3.1 (SMTP Internal Relay)
- Scheduler : PH11-06C.2 (Systemd Timers)

---

**Auteur** : KeyBuzz Backend Team  
**Reviewed** : ‚úÖ Tests E2E passed
